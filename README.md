# faultit
Make changes to your code while keeping whose at fault.

### Why
Sometimes when working on legacy codebases some formatting is needed.
Formatting using any of the known tools such as black, yapf, or whichever you prefer, leaves you with better code but none of the original authors.

Faultit is built as a tool to match modified lines with the lines before the changes and apply _new commits_ with the _original authors_.
This leaves you with both the formatted code and the original authors when looking at the blame.

### Installation

```bash
pip install faultit
```

### Usage

```bash
black .
isort .
faultit
```

### Features

- Match code based on similar words
- Group all lines changed by a commit to a new commit across all lines
- Generates commit with the same author as the original author

### Example

Using faultit on this code after running black and isort:

```python
Adam  2015-04-14 ...    def some_func(self, arg):
Adam  2015-04-14 ...        assert SomeClass.__name__ in obj.clients, \
Eve   2018-11-05 ...            '{} is adding itself to {} clients.' \
Eve   2018-11-05 ...                .format(self.__class__.__name__, SomeClass.__name__)
John  2016-11-16 ...        obj.property = self.property
Eve   2016-12-15 ...        obj.long_property_name = self.long_property_name
Adam  2015-04-14 ...        obj.clients[
Adam  2015-04-14 ...            self.__class__.__name__
Adam  2015-04-14 ...        ] = self
Adam  2015-04-14 ... 
Pete  2015-05-01 ...        obj.prop_dic.setdefault(self.SOME_LONG_NAME_CONST,
Pete  2015-05-01 ...                                SOME_LONG_NAME_CONST_DEFAULT)
Jude  2017-06-03 ...
Jude  2017-06-03 ...    import os
```

Will leave you with:
```python
Jude  2017-06-03 ...  import os
Adam  2015-04-14 ...  
Adam  2015-04-14 ...
Adam  2015-04-14 ...  def some_func(self, arg):
Adam  2015-04-14 ...      assert (
Adam  2015-04-14 ...          SomeClass.__name__ in obj.clients
Eve   2018-11-05 ...      ), "{} is adding itself to {} clients.".format(
Eve   2018-11-05 ...          self.__class__.__name__, SomeClass.__name__
Eve   2018-11-05 ...      )
John  2016-11-16 ...      obj.property = self.property
Eve   2016-12-15 ...      obj.long_property_name = self.long_property_name
Adam  2015-04-14 ...      obj.clients[self.__class__.__name__] = self
Jude  2017-06-03 ...
Pete  2015-05-01 ...      obj.prop_dic.setdefault(self.SOME_LONG_NAME_CONST, SOME_LONG_NAME_CONST_DEFAULT)
```

Now you might notice something weird in the next to last line, Jude wrote it and not Adam like previously.
This is because looking at the diff through git:
```diff
+import os
+
+
 def some_func(self, arg):
-    assert SomeClass.__name__ in obj.clients, \
-        '{} is adding itself to {} clients.' \
-            .format(self.__class__.__name__, SomeClass.__name__)
+    assert (
+       SomeClass.__name__ in obj.clients
+    ), "{} is adding itself to {} clients.".format(
+        self.__class__.__name__, SomeClass.__name__
+    )
     obj.property = self.property
     obj.long_property_name = self.long_property_name
-    obj.clients[
-        self.__class__.__name__
-    ] = self
-
-    obj.prop_dic.setdefault(self.SOME_LONG_NAME_CONST,
-                            SOME_LONG_NAME_CONST_DEFAULT)
+    obj.clients[self.__class__.__name__] = self

- import os
+    obj.prop_dic.setdefault(self.SOME_LONG_NAME_CONST, SOME_LONG_NAME_CONST_DEFAULT)
```

You can see git leaves the line written by Jude and not Pete.
I decided to follow git as a guideline so currently I'm keeping this.

### How does it work

Faultit looks at the diffs generated by git and for each diff tries to match lines by similarity.
If it cannot find a line to match to, faultit will try to match the line in the same offset in the diff.

Faultit will also try to match your line with other removed lines, making sure it wasn't moved during the formatting.
It will still prefer lines closer and in the current change, and searches for lines as a fallback.

### Thanks

This project's core is based on [this project by Alaya Care](https://github.com/AlayaCare/git-black).   
I opted into making a new codebase as I rewrote most of the code to make it more extendable and to fix some bugs.

### Roadmap

- [ ] Add proper test suite
- [ ] Make faultit configurable
- [X] Support other formatters that move lines around (isort for example)
- [ ] Add progress bar
